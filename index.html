<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wafula Educational Posts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      max-width: 100vw;
      overflow-x: hidden;
      font-family: Arial, sans-serif;
      background-color: white;
      color: #111;
      padding: 1rem;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark-mode {
      background-color: #121212;
      color: #eee;
    }
    .dark-mode a {
      color: #90cdf4;
    }
    #toggleMode {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
      border-radius: 4px;
      z-index: 100;
    }
    .post-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: inherit;
    }
    .post-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .read-more-link {
      display: inline-block;
      color: #007bff;
      margin-top: 0.5rem;
      text-decoration: underline;
      cursor: pointer;
    }
    iframe, img, video {
      margin-top: 10px;
      max-width: 100%;
    }
  </style>
</head>
<body>

<button id="toggleMode">üåô Dark Mode</button>

<div id="contentArea"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAwAxP-MWwNnKP59PA6joil4Ceq10eozlc",
    authDomain: "wafula-s-educational-posts.firebaseapp.com",
    projectId: "wafula-s-educational-posts"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const contentArea = document.getElementById("contentArea");
  const seenTitles = new Set();

  function getFirstNWords(text, n) {
    return text.split(/\s+/).slice(0, n).join(' ');
  }

  db.collection("posts").orderBy("timestamp", "desc").get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      const post = doc.data();
      const titleKey = post.title?.trim().toLowerCase();
      if (!titleKey || seenTitles.has(titleKey)) return;
      seenTitles.add(titleKey);

      const div = document.createElement("div");
      div.className = "post-card";

      const fullText = post.article || "";
      const previewText = getFirstNWords(fullText, 200);
      const isLong = fullText.split(/\s+/).length > 200;

      const contentDiv = document.createElement("div");
      contentDiv.innerHTML = `<p>${previewText}${isLong ? "..." : ""}</p>`;
      contentDiv.className = "preview";

      const fullDiv = document.createElement("div");
      fullDiv.style.display = "none";
      fullDiv.className = "full-article";
      fullDiv.innerHTML = fullText
        .split(/\n+/)
        .filter(p => p.trim() !== "")
        .map(p => `<p style="text-align: justify; margin-bottom: 1em;">${p.trim()}</p>`)
        .join("");

      const toggleLink = document.createElement("a");
      toggleLink.className = "read-more-link";
      toggleLink.textContent = "Read More";
      toggleLink.addEventListener("click", function () {
        if (fullDiv.style.display === "none") {
          fullDiv.style.display = "block";
          contentDiv.style.display = "none";
          toggleLink.textContent = "Show Less";
        } else {
          fullDiv.style.display = "none";
          contentDiv.style.display = "block";
          toggleLink.textContent = "Read More";
        }
      });

      div.innerHTML = `<h3 class="post-title">${post.title}</h3>`;
      if (post.category) {
        div.innerHTML += `<p style="font-weight:bold;">${post.category}</p>`;
      }

      div.appendChild(contentDiv);
      if (isLong) div.appendChild(toggleLink);
      div.appendChild(fullDiv);

      // Media display
      if (post.url) {
        const ext = post.url.split('.').pop().split('?')[0].toLowerCase();
        if (ext === "pdf") {
          div.innerHTML += `<iframe src="${post.url}" width="100%" height="400px"></iframe>`;
        } else if (["jpg", "jpeg", "png", "gif"].includes(ext)) {
          div.innerHTML += `<img src="${post.url}">`;
        } else if (["mp4", "webm"].includes(ext)) {
          div.innerHTML += `<video controls><source src="${post.url}" type="video/${ext}"></video>`;
        } else {
          div.innerHTML += `<a href="${post.url}" target="_blank" class="read-more-link">Download</a>`;
        }
      }

      contentArea.appendChild(div);
    });
  });

  // Light/Dark mode toggle
  const toggleBtn = document.getElementById("toggleMode");
  toggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    toggleBtn.textContent = document.body.classList.contains("dark-mode") ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
  });
</script>

</body>
</html>