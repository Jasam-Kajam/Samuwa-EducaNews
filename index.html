<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wafula Educational Posts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1em;
      overflow-x: hidden;
      background-color: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark-mode {
      background-color: #121212;
      color: #ddd;
    }
    .post-card {
      border-bottom: 1px solid #ccc;
      padding: 1em 0;
      margin-bottom: 1em;
    }
    .post-title {
      font-size: 1.3em;
      font-weight: bold;
    }
    .read-more-link {
      color: #007bff;
      cursor: pointer;
      text-decoration: underline;
    }
    .download-link {
      display: inline-block;
      margin-top: 10px;
      color: #007bff;
    }
    .toggle-mode {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #007bff;
      color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    select {
      margin-bottom: 1em;
      padding: 0.5em;
      font-size: 1em;
    }
    iframe, img, video {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <button class="toggle-mode" onclick="toggleMode()">Dark Mode</button>

  <h2>Wafula Educational Posts</h2>

  <label for="categoryFilter">Filter by Category:</label>
  <select id="categoryFilter">
    <option value="All">All</option>
  </select>

  <div id="contentArea"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAwAxP-MWwNnKP59PA6joil4Ceq10eozlc",
      authDomain: "wafula-s-educational-posts.firebaseapp.com",
      projectId: "wafula-s-educational-posts"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const contentArea = document.getElementById("contentArea");
    const categoryFilter = document.getElementById("categoryFilter");
    const seenTitles = new Set();
    const categorySet = new Set();

    function wordLimit(text, limit) {
      return text.split(/\s+/).slice(0, limit).join(" ");
    }

    function createPostElement(post) {
      const div = document.createElement("div");
      div.className = "post-card";

      const preview = wordLimit(post.article || "", 200);
      const isLong = (post.article || "").split(/\s+/).length > 200;

      let fullHTML = post.article
        ?.split(/\n+/)
        .filter(p => p.trim() !== "")
        .map(p => `<p style="text-align: justify; margin-bottom: 1em;">${p.trim()}</p>`)
        .join('') || "";

      let html = `
        <h3 class="post-title">${post.title}</h3>
        ${post.category ? `<p><strong>${post.category}</strong></p>` : ""}
        <div class="preview-text">${preview}${isLong ? "..." : ""}</div>
        ${isLong ? `<a class="read-more-link">Read More</a>` : ""}
        <div class="full-text" style="display:none;">${fullHTML}</div>
      `;

      if (post.url) {
        const ext = post.url.split('.').pop().split('?')[0].toLowerCase();
        if (ext === "pdf") {
          html += `<iframe src="${post.url}" width="100%" height="400px"></iframe>`;
        } else if (["jpg", "jpeg", "png", "gif"].includes(ext)) {
          html += `<img src="${post.url}" alt="Image">`;
        } else if (["mp4", "webm"].includes(ext)) {
          html += `<video controls><source src="${post.url}" type="video/${ext}"></video>`;
        } else {
          html += `<a class="download-link" href="${post.url}" target="_blank">Download File</a>`;
        }
      }

      div.innerHTML = html;
      div.dataset.category = post.category || "Uncategorized";
      return div;
    }

    function renderPosts(snapshot) {
      contentArea.innerHTML = "";
      seenTitles.clear();
      categorySet.clear();
      snapshot.forEach(doc => {
        const post = doc.data();
        const titleKey = post.title?.toLowerCase().trim();
        if (!titleKey || seenTitles.has(titleKey)) return;
        seenTitles.add(titleKey);
        if (post.category) categorySet.add(post.category);

        const el = createPostElement(post);
        contentArea.appendChild(el);
      });

      // Populate category filter
      categoryFilter.innerHTML = '<option value="All">All</option>';
      [...categorySet].sort().forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categoryFilter.appendChild(opt);
      });

      // Attach read more logic
      document.querySelectorAll(".read-more-link").forEach(link => {
        link.addEventListener("click", function () {
          const preview = this.previousElementSibling;
          const full = this.nextElementSibling;
          const isHidden = full.style.display === "none";
          full.style.display = isHidden ? "block" : "none";
          preview.style.display = isHidden ? "none" : "block";
          this.textContent = isHidden ? "Show Less" : "Read More";
        });
      });
    }

    categoryFilter.addEventListener("change", () => {
      const selected = categoryFilter.value;
      document.querySelectorAll(".post-card").forEach(card => {
        if (selected === "All" || card.dataset.category === selected) {
          card.style.display = "block";
        } else {
          card.style.display = "none";
        }
      });
    });

    db.collection("posts").orderBy("timestamp", "desc").get().then(renderPosts);

    function toggleMode() {
      document.body.classList.toggle("dark-mode");
      const btn = document.querySelector(".toggle-mode");
      btn.textContent = document.body.classList.contains("dark-mode") ? "Light Mode" : "Dark Mode";
    }
  </script>

</body>
</html>