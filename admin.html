<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Wafula Educational Posts</title>
  <script src="https://cdn.tiny.cloud/1/8s8goqpxlz92x5syaziw5j4j5muvw9kzicvz4vdbpgjenfqt/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAwAxP-MWwNnKP59PA6joil4Ceq10eozlc",
      authDomain: "wafula-s-educational-posts.firebaseapp.com",
      projectId: "wafula-s-educational-posts",
      storageBucket: "wafula-s-educational-posts.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    const storage = getStorage(app);

    // TinyMCE Init
    window.addEventListener('DOMContentLoaded', () => {
      tinymce.init({
        selector: '#article',
        plugins: [
          'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'image', 'link', 'lists',
          'media', 'searchreplace', 'table', 'visualblocks', 'wordcount', 'checklist', 'mediaembed',
          'casechange', 'formatpainter', 'pageembed', 'a11ychecker', 'tinymcespellchecker',
          'permanentpen', 'powerpaste', 'advtable', 'advcode', 'editimage', 'advtemplate',
          'mentions', 'tableofcontents', 'footnotes', 'autocorrect', 'typography'
        ],
        toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline | link image media table | checklist numlist bullist | emoticons charmap | removeformat',
        height: 400
      });
    });

    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          document.getElementById('loginPage').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
        })
        .catch((error) => {
          alert("Login Failed: " + error.message);
        });
    });

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const category = document.getElementById('category').value;
      const article = tinymce.get('article').getContent();
      const file = document.getElementById('file').files[0];

      if (article.length > 1000000) {
        alert("Article is too long. Please reduce it below 1MB.");
        return;
      }

      try {
        let fileURL = "";
        if (file) {
          const storageRef = ref(storage, 'uploads/' + file.name);
          await uploadBytes(storageRef, file);
          fileURL = await getDownloadURL(storageRef);
        }

        await addDoc(collection(db, "articles"), {
          title,
          category,
          content: article,
          fileURL,
          timestamp: new Date().toISOString()
        });

        alert("Article uploaded successfully!");
        document.getElementById('uploadForm').reset();
        tinymce.get('article').setContent('');
      } catch (err) {
        console.error(err);
        alert("Upload failed: " + err.message);
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
      } else {
        document.getElementById('loginPage').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
      }
    });
  </script>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage">
    <h2>Admin Login</h2>
    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" required><br><br>
      <input type="password" id="password" placeholder="Password" required><br><br>
      <button type="submit">Login</button>
    </form>
  </div>

  <!-- Admin Upload Panel -->
  <div id="adminPanel" style="display:none;">
    <h2>Post New Article</h2>
    <form id="uploadForm">
      <input type="text" id="title" placeholder="Title" required><br><br>
      <select id="category" required>
        <option value="">Select Category</option>
        <option value="Education">Education</option>
        <option value="News">News</option>
        <option value="PDF">PDF</option>
        <option value="Video">Video</option>
      </select><br><br>
      <textarea id="article">Write your article here...</textarea><br>
      <input type="file" id="file"><br><br>
      <button type="submit">Upload</button>
    </form>
  </div>
</body>
</html>